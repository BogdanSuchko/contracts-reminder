# Contract Bot

Сервис для мониторинга сроков контрактов сотрудников и автоматической рассылки уведомлений в Telegram.

## Возможности

- Приём актуальной Google Sheets таблицы или локальной загрузки.
- Генерация docx-уведомлений по продлению и прекращению контрактов.
- Рассылка напоминаний в Telegram с приложением документа.
- Планировщик ежедневных проверок, резервные проверки и команда для принудительной синхронизации.

## Конфигурация

1. Скопируй `config/env.example` в `.env` и заполни значения:
   - `BOT_TOKEN` — токен бота.
   - `CHAT_WHITELIST` — список разрешённых chat_id через запятую.
   - `FILES_DIR`, `GENERATED_DIR`, `TEMPLATES_DIR`, `META_DIR` — директории хранения.
   - `TIMEZONE`, `REMINDER_DAYS` — зона и стартовый горизонт напоминаний.
   - `YADISK_TOKEN` — оставь пустым, пока интеграция не подключена.
   - `GOOGLE_SHEET_ID`, `GOOGLE_SHEET_GID` (по умолчанию `0`), `GOOGLE_SHEET_NAME` (например `Контроль`), `GOOGLE_SHEET_FILENAME`.
   - `SHEET_SYNC_INTERVAL_MINUTES` — период синхронизации в минутах.
2. Таблица Google должна быть доступна на чтение «по ссылке».
3. Получи `chat_id`, отправив сообщение боту и вызвав `https://api.telegram.org/bot<TOKEN>/getUpdates`.

## Запуск локально

```bash
uv sync
uv run python -m contract_bot.main
```

Дополнительно:
- очистить кеш и архивы можно командой `uv run delete_cache`.

Команды бота:
- `/start` — регистрация чата и справка.
- `/status` — проверяет дату и имя последней синхронизации.
- `/sync` — принудительно тянет актуальные данные из Google Sheets.
- `/run` — вручную запустит проверку и рассылку без повторов.
- `/run_force` — принудительно отправит документы, даже если они уже уходили.
- `/help` — покажет краткую справку по командам.

## Структура таблицы и отметки

Парсер ориентируется на лист «Контроль» из калькулятора. Важные колонки:
- «Наименование организации», «Фамилия, имя, отчество», «Должность…».
- «Дата контракта», «Номер контракта», «Дата начала контракта», «Дата окончания контракта».
- «Уведомление», «Отметка о готовности», «Срок, на который продлён…».
- Дополнительно можно добавить колонку с текстом «Тип документа» (значения «продление»/«увольнение»).

Для скрытия уведомлений и фиксации результата используйте «Отметку о готовности»:
- `П` — действующий контракт продлевается (укажите новый срок).
- `Н` — заключается новый контракт.
- `Д` — новый контракт в связи с переводом.
- `И` — иные случаи (увольнение и др.).

Если отметка не проставлена, бот отправит оба варианта документов (продление и увольнение).
Горизонт напоминаний берётся из выпадающего списка в ячейке `G5` (или `F5`) листа, поддерживаются варианты `1 мес.`, `1 мес. 5 д.` и т.п.

## Планировщик

Каждое утро в 09:00 по `TIMEZONE` сервис:
1. Читает последний Excel из `FILES_DIR`.
2. Находит контракты, у которых до конца ≤ `SHEET_SYNC_INTERVAL_MINUTES` + выбранный горизонт (автоматически обновляется из таблицы).
3. Генерирует docx и присылает файл в каждый зарегистрированный чат (без повторов).

Если компьютер был выключен в 09:00, планировщик при следующем запуске выполнит отложенную задачу сразу. Дополнительно раз в час запускается резервная проверка, пока все актуальные уведомления не будут отправлены.

## Запуск в Docker

1. Убедись, что Docker установлен и запущен.
2. Подготовь `.env` как описано выше.
3. (Опционально) Создай директории для хранения данных: `storage/`, `generated/` рядом с проектом — они будут смонтированы в контейнер.
4. Собери образ и подними сервис:
   ```bash
   docker compose up --build -d
   ```
   Контейнер стартует с политикой `restart: unless-stopped`, так что после перезагрузки ПК он поднимется автоматически.
5. Логи контейнера можно посмотреть командой `docker compose logs -f`.

Чтобы остановить сервис:
```bash
docker compose down
```
Если хочешь очистить данные — удали содержимое `storage/` и `generated/` перед повторным запуском.

## Деплой на Railway

1. `railway up` и выбери репозиторий.
2. В Variables добавь переменные из `.env`.
3. Railway использует `railway.json` и `Procfile`, чтобы установить `uv` и запустить `uv run python -m contract_bot.main`.

## План по Яндекс.Диску

В коде уже есть `YandexDiskClient`-заглушка. Когда появится OAuth-токен — добавь реализацию `upload()` и ссылка автоматически попадёт в уведомление.

## Важно

Автообновление из Google Sheets требует учётных данных и токена доступа Google API — в текущей версии функция отключена. Для полноценной интеграции подготовь сервисный аккаунт и выдачу прав к таблице, после чего можно будет включить синхронизацию.

Также укажи `GOOGLE_SHEET_GID` (для первого листа — `0`) и `GOOGLE_SHEET_NAME` (лист, где лежит таблица, по умолчанию `Контроль`), а также интервал `SHEET_SYNC_INTERVAL_MINUTES` (по умолчанию 5 минут). Таблица должна быть доступна по ссылке для чтения.
