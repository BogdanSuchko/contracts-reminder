# Contract Bot

Сервис для мониторинга сроков контрактов сотрудников и автоматической рассылки уведомлений в Telegram.

## Возможности

- Автосинхронизация Google Sheets (или ручная командой `/sync`).
- Генерация docx-уведомлений по продлению и прекращению контрактов.
- Рассылка напоминаний в Telegram с приложением документа.
- Планировщик ежедневных проверок и заглушка для будущей интеграции с Яндекс.Диском.

## Конфигурация

1. Скопируй `config/env.example` в `.env` и заполни значения:
   - `BOT_TOKEN` — токен бота.
   - `CHAT_WHITELIST` — список разрешённых chat_id через запятую.
   - `FILES_DIR`, `GENERATED_DIR`, `TEMPLATES_DIR` — директории хранения файлов.
   - `TIMEZONE`, `REMINDER_DAYS` — зона и окно напоминаний (стартовое значение; далее берётся из таблицы).
   - `GOOGLE_SHEET_ID`, `GOOGLE_SHEET_GID` (обычно `0`), `GOOGLE_SHEET_NAME` (например, `Контроль`), `GOOGLE_SHEET_FILENAME` и `SHEET_SYNC_INTERVAL_MINUTES`.
   - `YADISK_TOKEN` — оставь пустым, пока интеграция не подключена.
2. Получи `chat_id`, отправив сообщение боту и вызвав `https://api.telegram.org/bot<TOKEN>/getUpdates`.

## Запуск локально

```bash
uv sync
uv run python -m contract_bot.main
```

Дополнительно:
- очистить кеш и архивы можно командой `uv run delete_cache`.

Команды бота:
- `/start` — регистрация чата и справка.
- `/status` — проверяет дату и имя последней синхронизации.
- `/sync` — принудительно тянет актуальные данные из Google Sheets.
- `/run` — вручную запустит проверку и рассылку без повторов.
- `/run_force` — принудительно отправит документы, даже если они уже уходили.
- `/help` — покажет краткую справку по командам.

## Запуск в Docker

```bash
# первый запуск
docker compose up --build -d

# посмотреть логи
docker compose logs -f

# остановить
docker compose down
```

Каталоги `storage/` и `generated/` монтируются из хоста, так что документы и архивы остаются на диске.

## Автозапуск на Windows

1. Создай файл `start-contract-bot.bat` рядом с проектом:
   ```bat
   @echo off
   cd /d D:\okay-kinda-a-real-project-but-with-smth-useful
   docker compose up -d
   ```
2. Открой «Планировщик заданий» → «Создать задачу…».
3. Триггер: «При входе в систему» (или «При запуске»).
4. Действие: «Запуск программы» → укажи созданный `.bat`, отметь «Выполнять с наивысшими правами».

Теперь контейнер будет подниматься автоматически при включении ПК. Остановить можно командой `docker compose down` либо сняв задачу в планировщике.

## Структура таблицы и отметки

Парсер ориентируется на лист «Контроль» из калькулятора. Важные колонки:
- «Наименование организации», «Фамилия, имя, отчество», «Должность…».
- «Дата контракта», «Номер контракта», «Дата начала контракта», «Дата окончания контракта».
- «Уведомление», «Отметка о готовности», «Срок, на который продлён…».
- Дополнительно можно добавить колонку с текстом «Тип документа» (значения «продление»/«увольнение»).

Для скрытия уведомлений и фиксации результата используйте «Отметку о готовности»:
- `П` — действующий контракт продлевается (укажите новый срок).
- `Н` — заключается новый контракт (укажите срок).
- `Д` — новый контракт в связи с переводом (срок можно сохранить для истории).
- `И` — иные случаи (увольнение и др.).

Если отметка не проставлена, бот отправит оба варианта документов (продление и увольнение).

## Планировщик

Каждое утро в 09:00 по `TIMEZONE` сервис:
1. Читает последнюю версию таблицы (сначала выполняется синхронизация).
2. Находит контракты, у которых до конца ≤ текущего горизонта напоминаний (берётся из `G5`/`F5`).
3. Генерирует docx и присылает файл в каждый зарегистрированный чат (без повторов).

Если компьютер был выключен в 09:00, планировщик при следующем запуске выполнит отложенную задачу сразу. Дополнительно раз в час запускается резервная проверка, пока все актуальные уведомления не будут отправлены.

## Деплой на Railway

1. `railway up` и выбери репозиторий.
2. В Variables добавь переменные из `.env`.
3. Railway использует `railway.json` и `Procfile`, чтобы установить `uv` и запустить `uv run python -m contract_bot.main`.

## План по Яндекс.Диску

В коде уже есть `YandexDiskClient`-заглушка. Когда появится OAuth-токен — добавь реализацию `upload()` и ссылка автоматически попадёт в уведомление.

## Важно

Автообновление из Google Sheets требует учётных данных и токена доступа Google API — в текущей версии функция отключена. Для полноценной интеграции подготовь сервисный аккаунт и выдачу прав к таблице, после чего можно будет включить синхронизацию.

Также укажи `GOOGLE_SHEET_GID` (для первого листа — `0`) и `GOOGLE_SHEET_NAME` (лист, где лежит таблица, по умолчанию `Контроль`), а также интервал `SHEET_SYNC_INTERVAL_MINUTES` (по умолчанию 5 минут). Таблица должна быть доступна по ссылке для чтения.
